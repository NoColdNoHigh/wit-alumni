<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no, target-densitydpi=device-dpi">
    <meta name="keywords" content="校友录，校友会,手机校友录，慧脑校友录">
    <meta name="description" content="慧脑校友录,手机校友录，校友会">
    <!--<link href="../img/ico/xy_ico.jpg" rel="apple-touch-icon-precomposed"/>-->
    <!--<link rel="stylesheet" type="text/css" href="../css/witcs0.css">-->
    <link rel="stylesheet" type="text/css" href="../css/alumni.css">
    <link rel="stylesheet" type="text/css" href="../css/witcs.css">
    <script src="../js/witjs.js"></script>
    <title>校友录</title>
</head>
<body class="ofa bgbody" onload="loadend()" onresize="autocss()">
<div id="s_select" class="none index999 fix bottom0 W11 CH callnone"></div>
<div class="index99 fix top0 H W11 AC ffHT color1 nav">慧脑校友录
    <img data-src='../images/icon/xy2.png' class="FL B4M H4M" onclick=""/>
    <img data-src='../images/icon/setting.png' class="FR ICON P05M"/>
</div>
<div class="W11 AC ofh MTH">
    <img data-src="../images/lantian.png" class="W11">
</div>
<img data-src="../images/caodi.png" class="W11  AC fix indexN bottom0">

<div class="W11 pb150 AC" id="mymsg">
    <div class="W11 AC F3">
        <img id="myImg" src="../images/port03.jpg" class="B6M H6M radius " onclick="window.open('msg.html')">
    </div>
    <!-- 个人信息开始 -->
    <div id="mydetails" class="W11 CH fix index100 top0 bgc9 none">
        <div class="index99 fix top0 H W11 AC ffHT color1">
            <img src='../images/icon/back_w.png' class="FL B4M H4M PD10 P05M" onclick="location.href='index.html'"/>
        </div>
        <img src="../images/myclass.jpg" alt="" class="W11">
        <div id="myinfor" class=" W11 ">
            <div class=" W11 TEXT bgcW MT05">
                <div class="FL W31 bold PT1M PB1M ">个人信息</div>
                <div class="clear"></div>
            </div>
            <div id="mymsg1" class=" bgc10">
                <div class="bordBD1 P1M H4M">
                    <div class="FL W31 AL">姓名</div>
                    <div id="myName" class="FR W32 AR "></div>
                    <div class="clear"></div>
                </div>
                <details open>
                    <summary class="FL AL W11 P1M bordBD1 ">已加班级</summary>
                    <div id="myAllClass"></div>
                </details>
                <div class="clear"></div>
            </div>
        </div>
    </div>
    <!-- 个人信息结束 -->
    <div id="class">
        <p id="class_p" class="bold F5 LH2 P1 ffKT color1">我的班级</p>
        <ul id="myclass" class="clear ffHT color1"></ul>
        <a onclick="_fun.show('d_add');">
            <img src="../images/icon/add.png" alt="" class="AC MA H2M MT">
        </a>
    </div>
    <div id="focus">
        <p class="bold F5 LH2 P1 ffKT color1">我的关注</p>
        <ul id="myfocus" class="clear ffHT color1"></ul>
        <a onclick="_wd.info('此功能暂未开放，敬请期待！','bgc5e')">
            <img src="../images/icon/add.png" alt="" class="AC MA H2M MT">

        </a>
    </div>
</div>


<!-- 添加班级开始 -->
<div id="d_add" class="none W11 ffWRYH CH fix index100 top0 bgca8b">
    <div class="CW CH fix ofa " onclick="_fun.hide(this.parentNode);"></div>
    <div class="relative W11 MT2H  rad05e LSP ffWRYH">
        <input name="industrycode" data-id="industry_code" placeholder="学校类别"
               class="rad05e clear FL MLT B10M H AL bgc107 bord_select" readonly="" data-t="radio"
               data-finp="clearschoolname"
               data-s="幼儿园,小学,初中,高中,中职,大学,研博,培训,特殊,其他" title="-1" value=""/>
        <input name="admdivcode" data-d="title" data-id="adm_div_code" placeholder="选择学校地域" readonly=""
               class="rad05e FL MLT C13MT2 H ALP bgc10 bord0 bord_select" value="" title=""
               onmousedown="creat_addr(3,0);"/>
        <input name="schoolname" data-id="unit_name" placeholder="选择学校" type="text"
               class="rad05e FL MLT A1T2 H ALP bord_select" value="" onclick="toSchool()" title="undefined"
               data-uid="undefined" readonly/>
        <!-- <div name="del" class="FR MRT B4M H AC radius bgc15 none">删</div> -->
        <input name="selectdate" data-id="date_start" placeholder="入学日期" readonly
               class=" rad05e FL MLT A21 H ALP border bord_select" onclick="wit_date.init(this,0, '012');"/>
        <div class="FL MT B1M H AC color1">-</div>
        <input name="selectdate" data-id="date_end" placeholder="毕业日期" readonly
               class="rad05e FL MT A21 H ALP border bord_select" onclick="wit_date.init(this,0, '012');"/>
        <div name="group" data-id="class_name" id="d_class" class="color75 rad05e  FL MLT A1T2 H ALP bord_select"
             data-in="title"
             required onclick="selectClass();">选择班级
        </div>
        <div class="rad05e FL MLT B9M H F4 AC bgc36 radH border MB" onclick="_fun.hide('d_add')">返回</div>
        <div name="submit" class="rad05e FR MRT B9M H F4 AC bgc36 radH border MB" onclick="addEdu(this.parentNode);">
            添加
        </div>
        <div class="clear"></div>
    </div>
</div>
<!-- 添加班级结束 -->
</body>
</html>
<!-- <script src="../js/witjs0.js"></script> -->
<script src="../js/wit_ajax.js"></script>
<script src="../js/postmessage.js"></script>
<script src="../js/witconfig.js"></script>
<script src="../js/witjsdate.js"></script>
<script src="../js/witjsaddr.js"></script>
<script src="../js/wit_app.js"></script>
<script type="text/javascript">
    "use strict";
    autocss();
    const _url = "http://121.43.233.185/alumnicloudweb";
    // const lo_url = "http://www.witknow.com/ljj/school/H5/Classmates.html";
    const lo_url = "Classmates.html";
    var _userguid = "10086", _token = "a7ed951bc954130d23c318ed4136cb61";

    function loadend() {
        autocss();
        loadimg();
        // postmessage({functionname: "getapp", callback: "callback"});

        postmessage({functionname: "getuser", callback: "callback"});

    }

    function C_schoolcata(d, c) {
        document.getElementById(d).innerHTML = "";
        c.forEach(function (v) {
            var div = document.createElement("div");
            var cid = getCut("||", 2, v.class_name);
            div.className = "MT MA C9M F3 LH3 AC ellips PL1M PR1M shadow0 bg_contain";
            div.style = "background-image:url(../images/muban1.png)";
            div.onclick = function () {
                window.location.href = lo_url + "?sid=" + v.unit_id + "&cid=" + cid + "&id=" + v.id;
                // window.location.href = "Classmates.html?sid=" + v.unit_id + "&cid=" + cid;
            };
            div.innerHTML =
                v.unit_name + " " + v.dept + " " + getCut("-", 0, v.date_end) + "届" + " " + getCut("||", 1, v.class_name) + "班";
            document.getElementById(d).appendChild(div);
        });
    }


    function C_mydetails(c) {
        document.getElementById("myAllClass").innerHTML = "";
        console.log(c);
        c.forEach(function (v) {
            var div = document.createElement("p");
            div.className = " AL W11 H4M  bordBD1 FL";
            div.innerHTML = '<div class="FL LH25">' + v.unit_name + " " + v.dept + " " + getCut("-", 0, v.date_end || "") + "届" + " " + getCut("||", 1, v.class_name) + "班" + '</div>' +
                '<div class="B3M H3M FR" onclick="del_school(' + v.id + ')" ><img class="B3M H3M P05M" src="../images/icon/delete.png" alt=""></div>  ';
            document.getElementById("myAllClass").appendChild(div);
        });
    }

    function del_school(id) {
        console.log(id);
        _wit.postmessage({
            functionname: "deleteexp",
            witparams: JSON.stringify({
                type: 0,
                id: id
            }),
            callbackparam: JSON.stringify({
                type: 0,
                id: id
            }),
            callback: "delExp"
        });
    }

    function delExp(msg, param) {
        console.log("正在删除");
        console.log(msg);
        var j = msg,
            p = JSON.parse(param);
        if (j && j.result >= 0) {
            _wd.info("删除成功！", "bgc5e");

            document.location.reload(); //当前页面
            _fun.show('mydetails');
            //其他端免回调
        } else {//pc端
            var o = p.json;
            console.log(o);
            console.log(p.type);
            p.type === 0 && externalfun.deleteexp(function (msg) {

                console.log(msg);
                _fun.toLoading(-1);
                var j = JSON.parse(msg);
                if (j.result >= 0) {
                    _wd.info("删除成功！", "bgc5e");
                    document.location.reload(); //当前页面
                    _fun.show('mydetails');
                }
            }, p.id, 0);
        }
    }

    function Show_Hidden(obj) {
        if (obj.style.display == "block") {
            obj.style.display = 'none';

        } else {
            obj.style.display = 'block';

        }
    }

    // console.log(getCut(".",0,""));
    function getCut(reg, num, msg) {
        if (msg) {
            var name = msg.split(reg);
            // console.log(name[num]);
            if (name) {
                return name[num] || "";
            }
        }
        return "";
    }

    function callback(msg) {
        console.log(msg);
        var info = msg.perinfo;
        //获取班级信息
        var myclass = info.perexpeducationjson;
        console.log(myclass);
        document.getElementById("myName").innerHTML = info.perobjectjson.per_full_name;
        C_schoolcata("myclass", myclass);
        C_mydetails(myclass);

        _wit.postmessage({functionname: 'getuserinfo', callback: 'init'});
    }

    function init(msg) {
        console.log(msg);
        if (msg.result >= 0) {
            var info = msg.message;
            _wit.event.input_UI("s_select", function (i, v, d) {
                console.log(i, v, d);
            });
            _wit.event.input_limit();
            var myImg = document.getElementById("myImg");

            myImg.src = info.localpath + info.per_portrait;

        } else {
            _wd.info("用户非法，请重新登录！", "bgc24");
            // _fun.toAlert("用户非法，请重新登录！");
        }
    }

    function addEdu(pd) {
        var o = {
            adm_div_code: "||",
            class_name: "||",
            date_end: "",
            date_start: "",
            depart: "",
            dept: "",
            honors: "",
            industry_code: "",
            position_name: "",
            relation_tag: "",
            unit_name: "",
            unit_id: "",
            per_user_guid: _userguid,
            exptype: 1
        };
        refill(pd, o); //填充数据
        console.log(o);
        console.log(o.date_end.length);
        if (o.adm_div_code == "||" || o.date_start.length == 0 || o.date_end.length == 0 || o.unit_name.length == 0) {
            // _fun.toAlert("请将数据填写完整再添加！");
            _wd.info("请将数据填写完整再添加！", "bgc5e");
        } else {
            _wit.postmessage({
                functionname: "createexp",
                witparams: JSON.stringify({
                    type: 0,
                    json: o
                }),
                callbackparam: JSON.stringify({
                    type: 0,
                    json: o
                }),
                callback: "cbExp"
            });
        }

    }

    function refill(pd, o) {
        var dl = pd.querySelectorAll("input,textarea"),
            dc = pd.querySelector("input[name='admdivcode']"),
            ds = pd.querySelector("input[name='schoolname']"),
            dcl = pd.querySelector("[name=group]"),
            dclr = pd.querySelector("#d_class"),
            d_type = pd.querySelector("[name=industrycode]"),
            de = document.querySelector("input[data-id='date_end']"),
            date = new Date(de.getAttribute("data-yl"));
        Array.prototype.forEach.call(dl, function (v) {
            for (var i in o) {
                if (i === v.dataset.id) {
                    o[i] = v.dataset.d === "title" ? v.title : v.value.trim();
                }
            }
        });
        var classmate = parseInt(dclr.innerText) > 9 ? parseInt(dclr.innerText) : "0" + parseInt(dclr.innerText);
        o.industry_code += "||" + d_type.title;
        o.unit_id = ds.title;
        o.class_name = "||" + parseInt(dclr.innerText) + "||" + o.unit_id + date.getFullYear() + d_type.title + classmate;
        o.adm_div_code += "||" + dc.value;
        return o;
    } //填充数据


    function selectClass() {
        var ds = document.querySelector("input[name='schoolname']").title;
        var dt = document.querySelector("input[name='industrycode']").title;
        var de = document.querySelector("input[data-id='date_end']");
        var date = new Date(de.getAttribute("data-yl"));
        console.log(ds + " " + date.getFullYear() + " " + dt);
        if (ds == "undefined" || dt < 0) {
            _wd.info("请将数据填写完整再添加！", "bgc5e");
        } else {
            toClassmates(ds, date.getFullYear(), dt, event.target)
        }
    }

    function toClassmates(s, y, t, d) {
        var sy = y + "";
        const para = {
            token: _token,
            userguid: _userguid,
            sid: s,
            type: t,
            sDate: sy
        };
        console.log(para);
        _fun.ajax_formdata(_url + "/class/queryBySTD.do", true, para, function (msg) {
            console.log(msg);
            const j = JSON.parse(msg);
            if (j.result >= 0 && j.message.length > 0) {
                _fun.toDownList(document.querySelector("#d_class"), function (a, p) {
                    console.log(a, p);
                    const dd = document.createElement("div"), df = document.createDocumentFragment();
                    dd.className = "relative HN4M HX36M ML A11 ofa";
                    dd.id = "d_classList";
                    a.innerHTML = '';
                    j.message.forEach(function (v) {
                        const div = document.createElement("div");
                        div.className = "relative W11 ALP H bgc18 ellips index10";
                        div.innerHTML = v.name + ":班主任（" + v.master + "）";
                        div.onclick = function () {
                            _fun.hide(p);
                            console.log(this);
                            d.innerHTML = v.name + ":班主任（" + v.master + "）";
                            d.title = v.guid;
                        };
                        df.appendChild(div);
                    });
                    dd.appendChild(df);
                    a.appendChild(dd);
//                    a.style.bottom = "";
//                    a.style.top = d.offsetTop + H + "px";
                })
            } else {
                _wd.info("无此班级信息！", "bgc24");
            }
        });
    }             //班级 关联信息

    function cbExp(msg, param) {
        console.log("正在添加");

        var j = msg,
            p = JSON.parse(param);
        if (j && j.result >= 0) {
            _wd.info("添加经历成功！", "bgc5e");
            document.location.reload(); //当前页面
            //其他端免回调
        } else {
            var o = p.json;
            console.log(o);
            console.log(p.type);
            //            return;
            p.type === 0 && externalfun.createexp(function (msg) {

                console.log(msg);
                _wd.toLoading();
                var j = JSON.parse(msg);
                if (j.result >= 0) {
                    _wd.info("添加经历成功！", "bgc5e");
                    document.location.reload(); //当前页面
                } else {
                    _wd.info("请选择学校类别！", "bgc5e");
                }
            }, JSON.stringify(o), 0);
        }
    }

    /***
     *  云录关联（经历）
     */
    function toSchool() {
        var t = event.target,
            p = t.parentNode,
            dt = p.querySelector("[name=industrycode]"),
            da = p.querySelector("[name=admdivcode]"),
            type = dt.title,
            area = da.title;
        if (!type || type < 0) {
            _wd.info("请选择学校类别！", "bgc5e");
            dt.click();
            return;
        }
        if (!area) {
            _wd.info("请选择学校所在地址！", "bgc5e");
            da.click();
            return;
        }
        var para = {
            token: _token,
            userguid: _userguid,
            sctype: type,
            adnum: area
        };
        console.log(para);
        _fun.ajax_formdata(_wit.path.server + "mavenwitlinkweb/school/retrieveschool.do", true, para, function (msg) {
            var j = JSON.parse(msg);
            console.log(j, t.screenTop);
            _fun.toDownList(t, function (a, p) {
                var dd = document.createElement("div"),
                    l = j.message,
                    dg = document.createDocumentFragment();
                dd.className = "relative HX24M ML A11 ofa";
                dd.id = "d_schoolList";
                a.innerHTML = "";
                var div = document.createElement("DIV");
                div.innerHTML = '<input type="text" class="FL relative C8M ALP H bgc10 ellips index10" placeholder="如没有您所在的学校，请手动添加" />' +
                    '<div class="FL B6M AC H bgc105">提交</div>';
                dg.appendChild(div);
                dg.querySelector("div>div").onclick = function () {
                    return;
                    var d = this.previousElementSibling,
                        dv = d.value.trim(),
                        ds = document.querySelector("#d_schoolList");
                    if (dv.length <= 0) {
                        d.focus();
                        return;
                    }
                    var ix = l.findIndex(function (v) {
                        return v.sc_name == dv;
                    });
                    if (ix >= 0) {
                        _wd.info("该学校已经存在！", "bgc5e");
                        ds.scrollTop = ds.children[ix + 1].offsetTop;
                        return;
                    }
                    var para = {
                        token: _token,
                        userguid: _userguid,
                        schooljson: {
                            id: "0",
                            sc_name: dv,
                            ad_num: (da.title + "0000").substring(0, 6),
                            sc_type: dt.title,
                            sc_id: 9000000000 + 100000000 * dt.title + 100 * (da.title + "0000").substring(0, 6) + 1 * l.length //最新编码
                            //dt.title + "" + (da.title + "0000").substring(0, 6) + "" + (l.length + 1)
                        }
                    };
                    console.log("自定义学校添加school/create:", para);
                    _fun.ajax_formdata(_wit.path.server + "mavenwitlinkweb/school/createschool.do", true, para, function (msg) {
                        console.log(msg);
                        var j = JSON.parse(msg);
                        if (j.result >= 0) {
                            // _fun.toAlert("添加成功！");
                            _wd.info("添加成功！", "bgc5e");
                            div = document.createElement("div");
                            div.className = "relative W11 ALP H bgc18 ellips index10";
                            div.setAttribute("readonly", "true");
                            div.dataset.id = para.schooljson.sc_id;
                            div.dataset.type = para.schooljson.sc_type;
                            div.innerHTML = para.schooljson.sc_name;
                            div.onclick = function () {
                                t.value = para.schooljson.sc_name;
                                t.title = para.schooljson.sc_id;
                                _fun.hide(p);
                                document.body.style.overflow = "";
                            };
                            ds.appendChild(div);
                            //                            ds.scrollTop = ds.children[ds.childElementCount - 1].offsetTop;
                        } else {
                            _wd.info("添加失败！" + j.message, "bgc24");
                        }
                        // _fun.toAlert("添加失败！" + j.message);
                    });
                };
                l.forEach(function (v) {
                    div = document.createElement("div");
                    div.className = "relative W11 ALP H bgc18 ellips index10";
                    div.setAttribute("readonly", "true");
                    div.dataset.id = v.sc_id;
                    div.dataset.type = v.sc_type;
                    div.innerHTML = v.sc_name;
                    div.onclick = function () {
                        t.value = v.sc_name;
                        t.title = v.sc_id;
                        _fun.hide(p);
                        document.body.style.overflow = "";
                    };
                    dg.appendChild(div);
                });
                dd.appendChild(dg);
                a.appendChild(dd);
            });
        }, function (msg) {
            _wd.info("获取学校失败！", "bgc24");
        })
    } //获取学校列表
    function toClass() {
        var t = event.target,
            p = t.parentNode,
            dt = p.querySelector("[name=schoolname]"),
            da = p.querySelector("[name=classdate]"),
            code = dt.title,
            time = da.value.slice(0, 4);
        if (!code) {
            _wd.info("请选择学校！", "bgc5e");
            dt.click();
            return;
        }
        if (!time) {
            _wd.info("请选择入学年级！", "bgc5e");
            da.click();
            return;
        }
        var para = {
            token: _token,
            userguid: _userguid,
            admdivcode1: code,
            industrycode: time
        };
        console.log("para:class/retrievebyai", para);
        _fun.ajax_formdata(_wit.path.server + "mavenwitlinkweb/class/retrievebyai.do", true, para, function (msg) {
            console.log(msg);
            var j = JSON.parse(msg);
            if (j.result >= 0 && j.message) {
                _fun.toDownList(t, function (a, p) {
                    var dd = document.createElement("div"),
                        l = j.message,
                        dg = document.createDocumentFragment();
                    dd.className = "relative HN4M HX24M ML A11 ofa";
                    dd.id = "classList";
                    a.innerHTML = "";
                    var div = document.createElement("DIV");
                    div.innerHTML = '<input type="text" class="FL relative C8M ALP H bgc10 ellips index10" placeholder="如没有您的班级，请手动添加全程" />' +
                        '<div class="FL B6M AC H bgc105">新建</div>';
                    div.querySelector("div").onclick = function () {
                        return;
                        var ipt = this.previousElementSibling;
                        if (ipt.value.trim().length <= 0) {
                            ipt.focus();
                            return;
                        }
                        _fun.hide(p);
                        document.body.style.position = "";
                        document.body.style.overflow = "";
                        var name = ipt.value.trim(),
                            linse = code + time + ("00" + ++j.message.length).slice(0, 3),
                            win = window.open("../cloud/cloud_cata.html");
                        win.addEventListener("load", function () {
                            win.winAdd({
                                license: linse,
                                admValue: dt.value,
                                admTitle: code,
                                ind: time,
                                name: name
                            });
                            return;
                            win.document.querySelector("#navList").children[4].click();
                            win.document.querySelector("#ipt_id").value = linse;
                            win.document.querySelector("#adm_div_code1").innerHTML = dt.value;
                            win.document.querySelector("#adm_div_code1").title = code;
                            win.document.querySelector("#industry_code").innerHTML = time;
                            win.document.querySelector("#industry_code").title = time;
                            win._fun.show(win._da);
                            win.document.body.style.position = "fixed"; //兼容移动端除了chrome外浏览器hidden无法生效
                            win.document.body.style.overflow = "hidden";
                            win.initAdd(win._da, {license: linse, unit: name});
                        });
                    };
                    dg.appendChild(div);
                    l.forEach(function (v) {
                        div = document.createElement("div");
                        div.className = "relative W11 ALP H bgc18 ellips index10";
                        div.setAttribute("readonly", "true");
                        div.dataset.id = v.unit_id;
                        div.innerHTML = v.unit_name;
                        div.onclick = function () {
                            t.value = v.unit_name;
                            t.title = v.unit_id;
                            _fun.hide(p);
                            //                            _fun.toConfirm("是否加入此班级云录！", function () {
                            //                                _page = 4;
                            //                                _info = myinfo.perobjectjson;
                            //                                join({name: v.unit_name, license: v.unit_id});
                            //                            }, {yes: "加入", no: "取消"});
                            document.body.style.position = "";
                            document.body.style.overflow = "";
                        };
                        dg.appendChild(div);
                    });
                    dd.appendChild(dg);
                    a.appendChild(dd);
                });
            } else {
                _wd.info("获取班级失败！", "bgc24");
            }
        });
    } //生成学校目录
</script>
