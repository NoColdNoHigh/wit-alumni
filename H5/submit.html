
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0">
    <title></title>
    <link rel="stylesheet" type="text/css" href="../css/witcs.css">
    <script src="../js/witjs.js"></script>
</head>
<body class="bgc2 ofa" onload="_wit.postmessage({functionname: 'getuser',callback: 'init'});" onresize="autocss();">
<div id="s_select" class="none index999 fix bottom0 W11 CH callnone"></div>
<header class="fix top0 W11 H F5 AC bgc72 color1">
    <span>校庆校友登记表</span>

    <div class="FL B4M H AC " onclick="window.close()"><</div>
    <div class="FR B4M H" onclick="window.open('../w/w3.html')">
        <img class="POT" data-src="../../img/a/help.png" lazy/>
    </div>
</header>
<div id="content" class="MTH CW CHNH AC bg_cover bgpB ofa">
    <div id="form">
        <p class="FL W11 F2 LH15 P05 AL"><span class="colorR">说明：
        </span>本次收集信息将用于完善校史档案、展示校友成就，还用于为各班级、各地域、各行业校友建立互助性社交云平台，加强联络与合作，创建温暖共赢的校友环境；为保证信息的真实性，还需输入手机验证码；完成登记后可登录校友云APP查看其它校友的工作信息或同班校友的通讯信息</p>

        <div class="FL MLT B10M H AC bgc73">毕业年届</div>
        <div id="d_year" class="FL MT C12MT2 H ALP bgc10 bord_select" onclick="wit_date.init(this,0, '0','年');" title="2001">2001年</div>
        <div class="FL MLT B10M H AC bgc73">学部</div>
        <div id="d_type" class="FL MT C12MT2 H ALP bgc10 bord_select" data-t="radio" data-s="小学,初中,高中" title="2">高中</div>
        <div class="FL MLT B10M H AC bgc73">班级</div>
        <div id="d_class" data-id="cid" class="FL MT C12MT2 H ALP bgc10 bord_select" data-in="title" required onclick="selectClass();">一班</div>
        <img id="per_portrait" class="clear FL MLT B9M H9M AC LH3 rad bgc108" alt="商务头像" data-src="../../img/port/port02.jpg"
             src="" onerror="this.src = '../../img/port/port02.jpg';" onclick="nextElementSibling.click();" lazy/>
        <input id="f_per_portrait" data-img="per_portrait" type="file" name="imgUpload" accept="image/*" class="none"
               onchange="_fun.previewImage(this,{},'per_portrait');"/>
        <input id="per_full_name" data-id="name" class="FL MLT C12M H AC rad" placeholder="姓 名"/>
        <input id="ipt_id" data-id="id" class="none"/>
        <ul id="per_sex" data-id="sex" data-in="data-radio" class="FL MT MR C12M H ACP">
            <li class="inlineB ML W31 H AC bgc5 radM">先生</li>
            <li class="inlineB ML W31 H AC bgc5 radM">女士</li>
        </ul>
        <div class="clear"></div>
        <div class="FL MLT B10M H F4 AC bgc65">当前住址</div>
        <div id="per_address0" data-id="acode" required data-in="title" class="FL MT C12MT2 H ALP bgc10 bord0 bord_select" onclick="creat_addr(4,0)">请选择所在区域</div>

        <input id="per_address1" data-id="addr" class="FL MLT A1T2 H F4 ALP bord0 " data-t="clear" placeholder="请输入详细地址"/>

        <div data-id="ret" data-in="title" class="FL MLT B9M H AC bgc10 bord_select" data-t="radio" data-s="工作单位,退休单位" title="0">工作单位</div>
        <input id="per_unit_name" data-id="comp" type="text" class="FL MLT C12M H ALP bgc10" data-t="clear" placeholder="请输入单位名称"/>

        <div id="per_dept" data-id="dept" class="FL MLT A21 F3 H3M LH2 AC radM bgc10 bord_select" data-t="check" placeholder="请选择部门"
             data-s="生产部,销售部,财务部,技术部,品质部,采购部,行政部,人事部,物流部,企划部,外贸部,市场部,设备部,总经办">请选择部门
        </div>
        <div id="per_position" data-id="job" class="FL MLT A21 F3 H3M LH2 AC radM bgc10 bord_select" data-t="check" placeholder="请选择职务"
             data-s="董事长,总经理,经理,主任,部长,局长,处长,科长,队长,组长,助理,科员,办事员,院长,书记,主席,总监,监理,总编,主编,主治">请选择职务
        </div>
        <div id="per_industry" data-id="industry" class="FL MLT A31 F3 H3M LH2 AC radM bgc10 bord_select" data-t="check" placeholder="请选择行业"
             data-arr="indusclass0">请选择行业
        </div>
        <div id="per_job_title" data-id="career" class="FL MLT A31 F3 H3M LH2 AC radM bgc10 bord_select" data-t="check" placeholder="请选择职称"
             data-s="教授,副教授,高级讲师,讲师,特级教师,高级教师,一级教师,研究员,副研究员,教授级高工,高级工程师,工程师,主任医师,副主任医师,主治医师,主管护师,高级经济师,经济师,高级会计师,会计师">请选择职称
        </div>
        <div id="per_education" data-id="education" class="FL MLT A31 F3 H3M LH2 AC radM bgc10 bord_select" data-t="check" placeholder="请选择最高学历"
             data-s="无,小学,初中,高中,中专,大专,本科,学士,硕士,博士">请选择最高学历
        </div>
        <div class="FL MLT B10M H AC bgc73">手机号码*</div>
        <input id="user_phone" data-id="phone" type="text" class="FL MT C12M H ALP alpha9" placeholder="请输入手机号" data-tt="number" required/>

        <details class="clear W11 H bordB color1">
            <summary class="W11 ALP">输入更多信息</summary>
            <div>
                <div class="FL MLT B10M H AC bgc73">邮编</div>
                <input type="text" data-id="zcode" class="FL MT C12MT2 H ALP bgc10" data-t="clear" placeholder="请输入邮编"/>

                <div class="FL MLT B10M H AC bgc73">邮箱</div>
                <input id="per_email" type="text" data-id="mail" class="FL MT C12MT2 H ALP bgc10" data-t="clear" placeholder="请输入邮箱"/>

                <div class="FL MLT B10M H AC bgc73">QQ</div>
                <input id="per_qq" type="text" data-id="qq" class="FL MT C12MT2 H ALP bgc10" data-t="clear" placeholder="请输入QQ"/>

                <div class="FL MLT B10M H AC bgc73">微信</div>
                <input id="per_webchat" type="text" data-id="wx" class="FL MT C12MT2 H ALP bgc10" data-t="clear" placeholder="请输入微信"/>

                <div class="FL MLT B10M H AC bgc73">生日</div>
                <div id="per_birth_date" data-id="birthday" data-in="title" class="FL MT C12MT2 H ALP bgc10 bord_select" onclick="wit_date.init(this,0, '012','年月日');">请选择生日</div>
            </div>
        </details>
        <div id="act_submit" class="FL MLT MA A11 H bgc16 rad" onclick="submit();">提交</div>
    </div>
    <div class="clear W11 H24M "></div>
</div>
<footer></footer>
</body>
</html>
<script src="../js/witconfig.js"></script>
<script src="../plug/witjsdate.js"></script>
<script src="../js/industryclass.js"></script>
<script src="../js/associating.js"></script>
<script src="../plug/witjsaddr.js"></script>
<script src="../js/lib/base64.js"></script>
<script src="../js/lib/MD5.js"></script>
<script>
    "use strict";
    autocss();
    let _info;
    const _path = {server: "http://121.43.233.185/alumnicloudweb/", local: "http://192.168.1.129:8080/"},
        _p = location.search.params();
    if (!_p.sid) location.href = location.href + "?sid=3330382";
    function init(msg) {
        console.log(msg);
        _fun.lazyload();
        _wit.event.input_del();
        _wit.event.input_limit();
        _wit.event.div_UI("s_select", function (i, v, d) {
            if (d && d.id == "d_type") {
                const dc = document.querySelector("#d_class");
                dc.innerHTML = "";
                dc.title = "";
            }
        });
        wit_date.call_back = function (d, o) {
            d.title = o.std;
            d.innerHTML = o.opt;
            if (d && d.id == "d_year") {
                const dc = document.querySelector("#d_class");
                dc.innerHTML = "";
                dc.title = "";
            }
        };
        _fun.radioClick("per_sex", [{className: {on: "inlineB ML W31 H AC bgc58 radM", off: "inlineB ML W31 H AC bgc5 radM"}}
            , {className: {on: "inlineB ML W31 H AC bgc68 radM", off: "inlineB ML W31 H AC bgc5 radM"}}], true, 0);
//        code && toInfo(code);
        _p.sid && toSchool();
        if (msg.result >= 0) {
            _info = msg.perinfo;
            toMember();
//            license && toCloud(license);
        }
    }                    //init
    function toPara() {
        const d = document.querySelector("#form"), dl = d.querySelectorAll("[data-id]"), p = {};
        for (let i in dl) {
            if (i == "length") break;
            let v = dl[i], di = v.dataset.in, rd = v.getAttribute("required") != null, rp = v.getAttribute("placeholder");
            let value = di ? v.getAttribute(di) : v.value || v.innerHTML.replace(rp, "");
            if (rd && !value) {
                v.focus();
                v.click();
                return false;
            }
            p[v.dataset.id] = value;
        }
        console.log(p);
        return p;
    }                     //生成提交参数
    function submit() {
        const p = toPara(), d = document.querySelector("#per_address0"), para = {};
        if (!p) return;
        p.sex++;
        p.cid = Number(p.cid);
        p.sid = Number(_p.sid);
        p.ret = p.ret | 0;
        p.graduation = "";
        p.honor = "";
        p.site = 0;
        p.date = new Date().getTime();
        p.checkmember = p.checkrank = p.checkdate = 0;
        p.addr += "@@" + d.innerHTML;
        p.acode = Number(p.acode);
        p.id = p.id | 0;
        para.json = p;
        para.logo = per_portrait.src.replace(/^data:image\/\w+;base64,/, "");
        console.log(para);
        _fun.ajax_formdata(_path.server + "member/insert.do", true, para, function (msg) {
            console.log(msg);
            var j = JSON.parse(msg);
            if (j.result >= 0) {
                _fun.toAlert("登记成功！");
            } else _fun.toAlert("登记失败！");
        });
    }                     //提交信息到校友录
    function fill(o) {
        for (const i in o) {
            if (Array.isArray(o[i])) continue;
            if (typeof o[i] == "object") fill(o[i]);
            else {
                const d = document.querySelector("#" + i);
                if (i == "per_address") {
                    const d0 = document.querySelector("#per_address0"), d1 = document.querySelector("#per_address1"), vl = o[i].split("@@");
//                    d0.innerHTML = vl[0];
//                    d0.title =
                    d1.value = vl[1] || "";
                } else if (i == "per_industry") {
                    const ix = o[i] / 100 | 0, v = indusclass0[ix];
                    d.innerHTML = v;
                } else if (d) {
                    switch (d.tagName.toUpperCase()) {
                        case "DIV":
                            d.innerHTML = o[i];
                            break;
                        case "INPUT":
                            d.value = o[i];
                            break;
                        case "IMG":
                            const img = new Image();
                            img.src = _imgpath + o[i];
                            img.onload = function () {
                                const cvs = document.createElement("canvas"), ctx = cvs.getContext("2d");
                                cvs.width = img.width;
                                cvs.height = img.height;
                                ctx.drawImage(this, 0, 0, cvs.width, cvs.height);
                                d.src = cvs.toDataURL();
                            };
                            break;
                        case "UL":
                            o[i] > 0 && d.children[--o[i]].click();
                            break;
                        default :
                            break;
                    }
                }
            }
        }
    }                      //慧联系数据填充
    function fillMember(o, path) {
        for (let i in o) {
            const d = document.querySelector("[data-id=" + i + "]");
            if (i == "phone") {
                d.value = o[i];
                const img = new Image();
                img.src = path + MD5(o[i]) + ".jpg";
//                document.body.appendChild(img);
                img.onload = function () {
                    const cvs = document.createElement("canvas"), ctx = cvs.getContext("2d");
                    cvs.width = img.width;
                    cvs.height = img.height;
                    ctx.drawImage(this, 0, 0, cvs.width, cvs.height);
                    per_portrait.src = cvs.toDataURL();
                };
            } else if (i == "cid") {
                d.title = o[i];
                toClassInfo(o[i], d);
            } else if (i == "addr") {
                const d0 = document.querySelector("#per_address0"), d1 = document.querySelector("#per_address1"), vl = o[i].split("@@");
                d0.innerHTML = vl[0];
                d1.value = vl[1] || "";
            } else if (i == "birthday") {
                d.title = new Date(o[i]).Format("yyyy-MM-dd");
                d.innerHTML = new Date(o[i]).Format("yyyy-MM-dd");
            } else if (d) {
                switch (d.tagName.toUpperCase()) {
                    case "DIV":
                        const attr = d.dataset.in;
                        attr ? d[attr] = o[i] : d.innerHTML = o[i];
                        break;
                    case "INPUT":
                        d.value = o[i];
                        break;
                    case "IMG":
                        break;
                    case "UL":
                        o[i] > 0 && d.children[--o[i]].click();
                        break;
                    default :
                        break;
                }
            }
        }
    }          //校友录数据填充
    function selectClass() {
        let dy = document.querySelector("#d_year"), dt = document.querySelector("#d_type");
        if ((dy.title >= 0 || dy.click()) && (dt.title >= 0 || dt.click())) {
            toClass(dy.title, (dt.title | 0) + 1, event.target);
        }
    }                //班级 选择

    function toSchool() {
        const para = {
            guid: _p.sid
        };
        _fun.ajax_formdata(_path.server + "school/queryByGuid.do", true, para, function (msg) {
            console.log(msg);
            const j = JSON.parse(msg);
            if (j.result >= 0) {
                const o = j.message[0];
                document.querySelector("header>span").innerHTML = o.name + " 校友登记";
            }
        }, function (msg) {
            console.log(msg)
        });
    }                   //学校 关联信息
    function toClass(y, t, d) {
        const para = {
            sid: _p.sid,
            type: t,
            sDate: y
        };
        console.log(para);
        _fun.ajax_formdata(_path.server + "class/queryBySTD.do", true, para, function (msg) {
            console.log(msg);
            const j = JSON.parse(msg);
            if (j.result >= 0 && j.message.length > 0) {
                _fun.toDownList(document.querySelector("#d_class"), function (a, p) {
//                    console.log(a, p);
                    const dd = document.createElement("div"), df = document.createDocumentFragment();
                    dd.className = "relative HN4M HX36M ML A11 ofa";
                    dd.id = "d_classList";
                    a.innerHTML = '';
                    j.message.forEach(function (v) {
                        const div = document.createElement("div");
                        div.className = "relative W11 ALP H bgc18 ellips index10";
                        div.innerHTML = v.name + ":班主任（" + v.master + "）";
                        div.onclick = function () {
                            _fun.hide(p);
                            console.log(this);
                            d.innerHTML = v.name + ":班主任（" + v.master + "）";
                            d.title = v.guid;
                        };
                        df.appendChild(div);
                    });
                    dd.appendChild(df);
                    a.appendChild(dd);
//                    a.style.bottom = "";
//                    a.style.top = d.offsetTop + H + "px";
                })
            } else _fun.toAlert("无此班级信息！");
        });
    }             //班级 关联信息
    function toMember() {
        const para = {
            phone: _info.perobjectjson.user_phone
        };
        _fun.ajax_formdata(_path.server + "member/queryByGuid.do", true, para, function (msg) {
            console.log(msg);
            const j = JSON.parse(msg);
            if (j.result >= 0) {
                fillMember(j.message[0], j.logoPath);
            } else fill(_info);
        }, function (msg) {
            console.log(msg);
            fill(_info);
        });
    }                   //成员 已有成员填充
    function toClassInfo(cid, td) {
        const para = {
            guid: cid
        };
        _fun.ajax_formdata(_path.server + "class/queryByGuid.do", true, para, function (msg) {
            const j = JSON.parse(msg);
            console.log(j);
            if (j.result >= 0 && j.message.length > 0) {
                const o = j.message.find(function (v) {
                    return v.guid == cid;
                });
                td.innerHTML = o.name + ":班主任（" + o.master + "）";
            } else fill(_info);
        }, function (msg) {
        });
    }         //班级 查询详情

    function toCloud(lincese) {
        const para = {};
        para.token = _info.token;
        para.userguid = _info.user_guid;
        para.companylicense = lincese;
        console.log(para);
        _fun.ajax_formdata(_wit.path.server + "mavenwitlinkweb/school/retrievebycompanylicense.do", true, para, function (msg) {
            const j = JSON.parse(msg);
            console.log(j);
            console.log(JSON.parse(Base64.decode(j.message.contactlist)));

//            create();
//            update(j.message);
//            j.message.msga = "S9@15158677106@刘晶晶";
//            updatemsga({token: j.message.token, userguid: j.message.userguid, unitid: j.message.unit_id, msga: j.message.msga});
        }, function (msg) {
            console.log(msg)
        });
    }             //关联校友云信息
    function toInfo(code) {
        const para = {
            CODE: code
        };
        _fun.ajax_formdata(_path.java + "/c/servlet/wechat/web/AccessTokenServlet?CODE=" + code, true, para, function (msg) {
            content.children[1].innerHTML = msg;
            const j = JSON.parse(msg);
            if (j.openid && j.access_token) {
                _fun.ajax_formdata(_path.java + "/c/servlet/wechat/web/UserInfoServlet?ACCESS_TOKEN=" + j.access_token + "&OPENID=" + j.openid, true, para, function (msg) {
                    content.children[2].innerHTML = msg;
                }, function (msg) {
                    _fun.toAlert(msg);
                });
            }
        }, function (msg) {
//            _fun.toAlert("用户验证失败！请退出后再次进入！");
        });
    }                 //关联wechat

</script>
