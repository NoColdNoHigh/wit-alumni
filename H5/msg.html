<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no, target-densitydpi=device-dpi">
    <meta name="keywords" content="校友录，校友会,手机校友录，慧脑校友录">
    <meta name="description" content="慧脑校友录,手机校友录，校友会">
    <link rel="stylesheet" type="text/css" href="../css/alumni.css">
    <link rel="stylesheet" type="text/css" href="../css/witcs.css">
    <script src="../js/witjs.js"></script>
    <title>校友录</title>
</head>
<style>
    input {
        display: block;
        outline: none;
    }

    input:focus {
        background: #FFF;
        text-align: center;
    }

    textarea:focus {
        background: #FFF;
        color: black;
        text-align: left;
    }
</style>
<body class="ofa" onload="loadend()" onresize="autocss()">
<div id="s_select" class="none index999 fix bottom0 W11 CH callnone "></div>
<div id="re_page" class="none index99 fix bottom0 W11 CH callnone"></div>
<div class="W11  bgc9  ffWRYH">
    <div class="index9 fix top0 H W11 AC ffHT  bgc9">个人信息
        <img src='../images/icon/back_b.png' class="FL P1M B4M H4M" onclick="_wit.winclose();"/>
        <div class="H4M FR F3 colorff PR1M" onclick="save();">保存</div>
    </div>
    <div class=" W11 MTH PL1M PR1M bgc10  bordBDe6">
        <div class="H6M flexbox">
            <div class="W31 FL H AL">头像</div>
            <div class="W32 FR  flexbox">
                <div class="W11 AR H6M">
                    <img id="myImg" class="H6M B6M P05M rad1 AR " data-id="per_portrait_social" alt=""
                         data-src="../images/port03.jpg"
                         onerror="this.src ='../images/port03.jpg' "
                         src=""
                         onclick="_wit.postmessage({functionname: 'selectphoto',callback: 'selectphone_callback',callbackparam:JSON.stringify({ipt:'f_logo',img:'myImg'})});"
                         lazy/>
                    <input id="f_logo" data-img="per_portrait" type="file" name="imgUpload" accept="image/*"
                           class="none"
                           onchange="_fun.previewImage(this,{},'myImg');"/>
                </div>
                <div class=" AR color8">
                    <div class=" AR">&#62</div>
                </div>
            </div>
        </div>
    </div>

    <div class="H1M W11 bgcaf5 bordBDe6"></div>
    <div class=" W11  PL1M PR1M bgc10  bordBDe6">
        <div class="bordBDe6  H4M flexbox">
            <div class="W31 FL H AL">名字</div>
            <input type="text" class="W32 bordBDe6  FR AR color8 H ellips ffWRYH " id="myname"
                   data-id="per_full_name"
                   placeholder="" value=""/>
            <div class="ML AR color8">
                <div class=" AR">&#62</div>
            </div>
        </div>
        <div class="bordBDe6  H4M flexbox">
            <div class="W31 FL H AL">性别</div>
            <div id="mysex" class="W32 FR AR color8 H ellips" title="-1" data-t="radio" data-l="my_msg"
                 data-id="per_sex" data-s="男,女"></div>
            <div class="ML AR color8">
                <div class=" AR">&#62</div>
            </div>
        </div>
        <div class="  H4M flexbox">
            <div class="W31 FL H AL">生日</div>
            <div data-in="title" id="mybirthday" class="W32 FR AR color8 H ellips" data-l="my_msg"
                 data-id="per_birth_date" onclick="wit_date.init(this,0, '012','年月日');">
            </div>
            <div class="ML AR color8">
                <div class=" AR">&#62</div>
            </div>
        </div>
    </div>
    <div class="H1M W11 bgcaf5 bordBDe6"></div>
    <div class=" W11  PL1M PR1M bgc10  bordBDe6">
        <div class="bordBDe6  H4M flexbox">
            <div class="W31 FL H AL">邮箱</div>
            <input type="text" class="W32 bordBDe6  FR AR color8 H ellips ffWRYH " id="mymail"
                   data-id="per_email" placeholder="" value=""/>
            <div class="ML AR color8">
                <div class=" AR">&#62</div>
            </div>
        </div>
        <div class="bordBDe6   H4M flexbox">
            <div class="W31 FL H AL">QQ</div>
            <input type="text" class="W32 bordBDe6 FR AR color8 H ellips ffWRYH " id="myqq" data-id="per_qq"
                   placeholder=""
                   value=""/>
            <div class="ML AR color8">
                <div class=" AR">&#62</div>
            </div>
        </div>
        <div class="  H4M flexbox">
            <div class="W31 FL H AL">微信</div>
            <input type="text" class="W32 FR AR color8 H ellips ffWRYH " id="mywx" data-id="per_webchat"
                   placeholder=""
                   value=""/>
            <div class="ML AR color8">
                <div class=" AR">&#62</div>
            </div>
        </div>
    </div>
    <div class="H1M W11 bordBDe6"></div>
    <div class=" W11  PL1M PR1M bgc10  bordBDe6 ">
        <div class="H4M bordBDe6">
            <div class="flexbox">
                <div class="W41 FL H AL">地址</div>
                <div id="myaddr" data-in="title" class="W43 FR AR color8 H ellips" title=""
                     onclick="creat_addr(4,0)">请选择所在区域
                </div>
                <div class="ML AR color8">
                    <div class=" AR">&#62</div>
                </div>
            </div>
        </div>
        <div class=" HN4M flexbox">
            <div class="W41 FL H AL">详细地址</div>
            <textarea class=" FL W43  F4 AR  color8 ffWRYH " rows="2" style="resize:none" id="myaddr1"
                      title=""></textarea>
            <div class=" AR color8">
                <div class=" AR">&#62</div>
            </div>
        </div>
        <input data-id="per_address" id="address" class="none" placeholder="请输入地址">
    </div>
    <div class="H1M W11 bordBDe6"></div>
    <div class=" W11  PL1M PR1M bgc10  bordBDe6">
        <div class=" H4M flexbox">
            <div class="W31 FL H AL">学历</div>
            <div id="myeducation" class="W32 FR AR color8 H ellips" data-t="check" data-id="per_education"
                 data-l="my_msg" data-s="无,小学,初中,高中,中专,大专,本科,学士,硕士,博士">
            </div>
            <div class="ML AR color8">
                <div class=" AR">&#62</div>
            </div>
        </div>
    </div>
    <div class="H1M W11 bordBDe6"></div>
    <div class=" W11  PL1M PR1M bgc10  bordBDe6">
        <div class="bordBDe6  H4M flexbox">
            <div class="W31 FL H AL">行业</div>
            <div id="myindustry" class=" W32 FR AR color8 H ellips" data-t="check" data-l="my_msg"
                 data-id="per_industry"
                 data-s="其它, 公务, 教育, 医疗, 科研设计, 农业, 食品, 纺织服饰, 轻工, 能源矿材, 化工, 五金机电, 仪器仪表, 家电, 设备制造, 建筑房产, 交通工业, 物流服务, 信息产业, 商贸, 金融, 商务服务, 居民服务, 环境管理, 文化娱乐, 餐住旅游">
            </div>
            <div class="ML AR color8">
                <div class=" AR">&#62</div>
            </div>
        </div>
        <div class="bordBDe6  H4M flexbox">
            <div class="W31 FL H AL">单位</div>
            <input type="text" class="W32 bordBDe6  FR AR color8 H ellips ffWRYH " id="mycomp"
                   data-id="per_unit_name"
                   placeholder="" value=""/>
            <div class="ML AR color8">
                <div class=" AR">&#62</div>
            </div>
        </div>

        <div class="bordBDe6  H4M flexbox">
            <div class="W31 FL H AL">部门</div>
            <div id="mydept" class="W32 FR AR color8 H ellips" data-t="check" data-l="my_msg" data-id="per_dept"
                 data-s="生产部,销售部,财务部,技术部,品质部,采购部,行政部,人事部,物流部,企划部,外贸部,市场部,设备部,总经办">
            </div>
            <div class="ML AR color8">
                <div class=" AR">&#62</div>
            </div>
        </div>
        <div class="bordBDe6  H4M flexbox">
            <div class="W31 FL H AL">职务</div>
            <div id="myjob" class="W32 FR AR color8 H ellips" data-t="check" data-l="my_msg" data-id="per_position"
                 data-s="董事长,总经理,经理,主任,部长,局长,处长,科长,队长,组长,助理,科员,办事员,院长,书记,主席,总监,监理,总编,主编,主治">
                <!--<div id="myjob" class="W32 FR AR color8 ellips" data-t="my_msg">-->
            </div>
            <div class="ML AR color8">
                <div class=" AR">&#62</div>
            </div>
        </div>
        <div class="  H4M flexbox">
            <div class="W31 FL H AL">职称</div>
            <div id="mycareer" class="W32 FR AR color8 H ellips" data-t="check" data-l="my_msg"
                 data-id="per_job_title"
                 data-s="教授,副教授,高级讲师,讲师,特级教师,高级教师,一级教师,研究员,副研究员,教授级高工,高级工程师,工程师,主任医师,副主任医师,主治医师,主管护师,高级经济师,经济师,高级会计师,会计师">
                <!--<div id="mycareer" class="W32 FR AR color8 ellips" data-t="my_msg">-->
            </div>
            <div class="ML AR color8">
                <div class=" AR">&#62</div>
            </div>
        </div>

    </div>
    <div class=" H1M W11 bordBDe6"></div>
    <div class=" W11  bgc119  bordBDe6">
        <details>
            <summary class="FL H AL W11 PL1M bordBD1 ">已加班级</summary>
            <div id="myAllClass"></div>
        </details>
        <div class="clear"></div>
    </div>
    <div class=" H1M W11 bordBDe6"></div>
    <div class="W11 H AC bgcff" id="saveMsg" onclick="save();">保存</div>
</div>
</body>
</html>
<script src="../js/wit_ajax.js"></script>
<script src="../js/witconfig.js"></script>
<script src="../js/witjsdate.js"></script>
<script src="../js/witjsaddr.js"></script>
<script src="../js/wit_app.js"></script>
<script src="../js/lib/MD5.js"></script>
<script type="text/javascript">
    "use strict";
    autocss();
    var _userguid, _token, _editor, _phone;
    const _url = "http://121.43.233.185/alumnicloudweb";
    var myObject, myPrivacy, myPersocial;
    var myinfo;

    function loadend() {
        loadimg();
        _wit.postmessage({functionname: "getuser", callback: "callback"});
    }

    function callback(msg) {
        console.log(msg);
        var info = msg.perinfo;
        myinfo = msg.perinfo;
        //获取班级信息
        var myclass = info.perexpeducationjson;
        myObject = info.perobjectjson;
        myPrivacy = info.perprivacyobjectjson;
        myPersocial = info.persocialinforobjectjson;
        console.log(myclass);
        C_mydetails(myclass);
        _wit.postmessage({functionname: 'getuserinfo', callback: 'init'});
    }

    function init(msg) {
        console.log(msg);
        if (msg.result >= 0) {
            var info = msg.message;
            _userguid = info.user_guid;
            _token = info.token;
            _editor = info.per_full_name;
            _phone = info.user_phone;
            _wit.event.input_UI("s_select", function (i, v, d) {
                console.log(i, v, d);
            });
            var myImg = document.getElementById("myImg");
            console.log(myImg);
            if (info.per_portrait_social) {
                myImg.src = info.localpath + info.per_portrait_social;
            } else if (info.per_portrait) {
                myImg.src = info.localpath + info.per_portrait;
            } else {
                myImg.src = "../images/port03.jpg";
            }
            myImg.src += "?t=" + new Date().getTime();
            getClassMsg();
            _wit.event.div_UI("s_select");
            _wit.event.input_limit();

        } else {
            _wd.info("用户非法，请重新登录！", "bgc24");
        }
    }

    function C_mydetails(c) {
        document.getElementById("myAllClass").innerHTML = "";
        console.log(c);
        c.forEach(function (v) {
            var div = document.createElement("div");
            var class_name = "未知班", date_end = "未知",cid = "";
            if (v.class_name.indexOf("||") > -1) {
                cid = _wd.getCut("||", 3, v.class_name);
                console.log(cid);
                class_name = _wd.getCut("||", 2, v.class_name);
                if (class_name.indexOf("班") < 0) {
                    class_name = class_name + "班";
                }
                if (v.date_end) {
                    if (v.date_end.indexOf("-") > -1) {
                        date_end = _wd.getCut("-", 0, v.date_end);
                    }
                }
                div.className = " AL W11 H ellips PL1M bordBD1 FL";
                div.innerHTML = '<div class="FL W65 ellips">' +  v.unit_name + v.dept + date_end + "届" + class_name + '</div>' +
                    '<div class="B4M H4M FR" onclick="del_school(' + v.id + ')" ><img class="B4M H4M P1M" src="../images/icon/delete.png" alt=""></div>  ';
                document.getElementById("myAllClass").appendChild(div);
            }
        });
    }

    function getClassMsg() {
        const c = myPrivacy;
        const o = myObject;
        const b = myPersocial;
        console.log(c, o, b);
        const ca = document.getElementById("myindustry").getAttribute("data-s");
        var myName = document.getElementById("myname");
        myName.value = o.per_full_name || "";
        var mySex = document.getElementById("mysex");
        var sex = "";
        switch (o.per_sex) {
            case 1:
                sex = "男";
                break;
            case 2:
                sex = " 女";
                break;
            default:
                sex = "";
                break;
        }
        mySex.title = parseInt(o.per_sex - 1);
        mySex.innerText = sex;
        var mybirth = document.getElementById("mybirthday");
        mybirth.innerText = b.per_birth_date || "";

        var myMail = document.getElementById("mymail");
        myMail.value = o.per_email || o.per_email2 || "";

        var myQQ = document.getElementById("myqq");
        myQQ.value = o.per_qq || "";

        var myWX = document.getElementById("mywx");
        myWX.value = o.per_webchat || "";

        var myAddr = document.getElementById("myaddr");
        var myAddr1 = document.getElementById("myaddr1");
        var a = o.per_address.split("||");
        // console.log(a.length);
        // if (a.length > 1) {
        myAddr.title = a[1] || "";
        var addr = a[0].split("@@");
        if (addr.length > 1) {
            myAddr.innerText = addr[0];
            myAddr1.value = addr[1];
        }
        // }
        var myEdu = document.getElementById("myeducation");
        myEdu.innerText = c.per_education || "";

        var myIndustry = document.getElementById("myindustry");
        myIndustry.innerText = _wd.getCut(", ", parseInt(parseInt(o.per_industry) / 100), ca) || "";
        myIndustry.title = parseInt(parseInt(o.per_industry)) || "";

        var myComp = document.getElementById("mycomp");
        myComp.value = o.per_unit_name || "";

        var myCareer = document.getElementById("mycareer");
        myCareer.innerText = c.per_job_title || "";

        var myDept = document.getElementById("mydept");
        myDept.innerText = o.per_dept || "";

        var myJob = document.getElementById("myjob");
        myJob.innerText = o.per_position || "";
    }

    function save() {
        console.log(myinfo);
        try {
            if (update(myinfo)) {
                if (document.getElementById("myImg").src.indexOf('base64') < 0) {
                    myinfo.perobjectjson.per_portrait_social = "";
                }
                if (myinfo.perobjectjson.per_full_name.length <= 0) {
                    _wd.info("姓名不能为空！", "bgc24");
                    return;
                }
                var theinfo = {};
                _fun.extendDeep(theinfo, myinfo, true);
                delete theinfo.perexpjobjson;
                delete theinfo.perexpeducationjson;
                delete theinfo.perexpotherjson;
                delete theinfo.perconsumeobjectjson;
                _wd.toLoading();
                console.log(theinfo);
                _wit.postmessage({
                    functionname: "updateuserinfo",
                    witparams: {
                        json: JSON.stringify(theinfo)
                    },
                    callback: "cb_updateMsg"
                });
            }
        } catch (ex) {
            _wd.info(ex, "bgc24");
            // _fun.toLoading();
            throw ex;
        }
    }

    function cb_updateMsg(msg) {
        console.log(msg);
        var p = msg.result;
        if (p >= 0) {
            _wd.info("修改成功！", "bgc5e", 500);
            opener.location.reload();
            setTimeout(function () {
                window.location.reload();
            }, 1000)

        } else {
            _wd.info("修改失败！", "bgc24", 500);
            opener.location.reload();
            setTimeout(function () {
                window.location.reload();
            }, 1000)
        }
    }

    function update(j) {
        if (j === undefined)
            return false;
        else var d = j;
        for (var i in d) {
            if (typeof (d[i]) === "object" && !(d[i] instanceof Array)) {
                update(d[i]);
            }
            var obj = document.querySelector("[data-id='" + i + "']");
            if (obj) {
                var tag = obj.tagName;
                if (tag === "INPUT") {
                    if (obj.id === "address") {
                        var addr = document.querySelector("#myaddr").innerHTML,
                            addr1 = document.querySelector("#myaddr1").value,
                            acode = document.querySelector("#myaddr").title;
                        d[i] = addr + "@@" + addr1 + "||" + acode;
                        d[i] = d[i] === "@@||" ? "" : d[i];
                    } else {
                        d[i] = obj.value;
                    }
                } else if (tag === "DIV") {
                    console.log(obj.id);
                    if (obj.id === "mysex") {
                        d[i] = parseInt(obj.title) + 1;
                        continue;
                    }
                    if (obj.id === "myindustry") {
                        if (parseInt(obj.title) < 100) {
                            d[i] = parseInt(obj.title) * 100;
                        } else {
                            d[i] = parseInt(obj.title);
                        }
                    }
                    else {
                        d[i] = obj.innerText;
                    }
                } else if (tag === "IMG") {
                    d[i] = obj.src;
                    console.log(1);
                }
                else if (tag === "IMG") {
                    d[i] = obj.src;
                    console.log(1);
                }
            } else {
                //console.log(2);
            }
        }
        return true;
    }

    function del_school(id) {
        console.log(id);
        _wit.postmessage({
            functionname: "deleteexp",
            witparams: {
                type: 0,
                id: id
            },
            callbackparam: JSON.stringify({
                type: 0,
                id: id
            }),
            callback: "delExp"
        });
    }

    function delExp(msg, param) {
        console.log("正在删除");
        console.log(msg);
        var j = msg,
            p = JSON.parse(param);
        if (j && j.result >= 0) {
            _wd.toLoading();
            _wit.postmessage({functionname: "getuser", callback: "callback"});
            setTimeout(function () {
                opener.location.reload();
                _wd.info("删除成功！", "bgc5e");
            }, 1000)
            // document.location.reload(); //当前页面
            //其他端免回调
        } else {
            _wd.info("删除失败！", "bgc24");
        }
    }

    function selectphone_callback(msg, para) {
        console.log("调用相册：", msg, para);
        var j = msg, p = JSON.parse(para), img = document.querySelector("#" + p.img),
            d = document.querySelector("#" + p.ipt);
        if (j && j.result >= 0) {
            img.src = j.message;
        } else {
            d.click();
        }
    }          //调用相册

</script>
